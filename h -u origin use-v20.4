[33mcommit 1557c44f1dcd02f664e4a83d616a0ff4bd8eca25[m
Author: krucif1x <lamadongbernardo@gmail.com>
Date:   Sun Jan 11 16:25:19 2026 +0700

    v20.4: refactored status related coding as well as cleaned up utils folder. Still need further refactoring as for some reason fps has dropped from 20 to 14.

[1mdiff --git a/data/drowsiness_events.db b/data/drowsiness_events.db[m
[1mindex 06226a4..ff4c9ab 100644[m
Binary files a/data/drowsiness_events.db and b/data/drowsiness_events.db differ
[1mdiff --git a/src/core/detection_loop.py b/src/core/detection_loop.py[m
[1mindex 9243809..ec50bb2 100644[m
[1m--- a/src/core/detection_loop.py[m
[1m+++ b/src/core/detection_loop.py[m
[36m@@ -6,9 +6,9 @@[m [mimport cv2[m
 [m
 from src.calibration.main_logic import EARCalibrator[m
 from src.core.status_aggregator import StatusAggregator[m
[31m-from src.detectors.distraction import DistractionDetector[m
[31m-from src.detectors.drowsiness import DrowsinessDetector[m
[31m-from src.detectors.expression import MouthExpressionClassifier[m
[32m+[m[32mfrom src.status.distraction.detector import DistractionDetector[m
[32m+[m[32mfrom src.status.drowsiness.detector import DrowsinessDetector[m
[32m+[m[32mfrom src.status.expression import MouthExpressionClassifier[m
 from src.mediapipe.hand import MediaPipeHandsWrapper[m
 from src.mediapipe.head_pose import HeadPoseEstimator[m
 from src.utils.constants import L_EAR, M_MAR, R_EAR[m
[1mdiff --git a/src/detectors/distraction.py b/src/detectors/distraction.py[m
[1mdeleted file mode 100644[m
[1mindex b962fa8..0000000[m
[1m--- a/src/detectors/distraction.py[m
[1m+++ /dev/null[m
[36m@@ -1,202 +0,0 @@[m
[31m-import time[m
[31m-import logging[m
[31m-from collections import deque[m
[31m-[m
[31m-from src.utils.load_detector_config import load_yaml_section[m
[31m-[m
[31m-log = logging.getLogger(__name__)[m
[31m-[m
[31m-[m
[31m-class DistractionDetector:[m
[31m-    """[m
[31m-    Simple camera-appropriate distraction detector:[m
[31m-    - Camera shows face + shoulders only (hands normally NOT visible)[m
[31m-    - If ANY hand appears in frame = driver not holding wheel properly[m
[31m-    - Also checks extreme head angles (looking away)[m
[31m-    """[m
[31m-[m
[31m-    def __init__(self, fps=30.0, camera_pitch=0.0, camera_yaw=0.0, config_path="config/detector_config.yaml"):[m
[31m-        self.fps = fps[m
[31m-        self.cfg = self._load_config(config_path, fps)[m
[31m-[m
[31m-        # State[m
[31m-        self.is_distracted = False[m
[31m-        self.distraction_type = "NORMAL"[m
[31m-        self.start_time = None[m
[31m-[m
[31m-        # Calibration[m
[31m-        self.cal = {"pitch": camera_pitch, "yaw": camera_yaw}[m
[31m-[m
[31m-        # History: track violations over last N frames (from YAML)[m
[31m-        self.history = deque(maxlen=int(self.cfg["history_frames"]))[m
[31m-[m
[31m-        # Metrics[m
[31m-        self.metrics = {"total_distractions": 0}[m
[31m-[m
[31m-        # Track partial face visibility (from YAML)[m
[31m-        self.face_visibility_history = deque(maxlen=int(self.cfg["face_visibility_history_frames"]))[m
[31m-        self.partial_face_threshold = float(self.cfg["partial_face_threshold"])[m
[31m-        self.face_present_min_samples = int(self.cfg["face_present_min_samples"])[m
[31m-[m
[31m-        log.info("DistractionDetector initialized (Simple hand-based)")[m
[31m-[m
[31m-    def _load_config(self, path, fps):[m
[31m-        defaults = {[m
[31m-            # thresholds[m
[31m-            "yaw_deg": 45.0,[m
[31m-            "pitch_down_deg": 20.0,[m
[31m-            "pitch_up_deg": 20.0,[m
[31m-            # timing[m
[31m-            "hands_visible_sec": 1.5,[m
[31m-            "gaze_sec": 1.2,[m
[31m-            # smoothing[m
[31m-            "history_frames": 5,[m
[31m-            "required_frames": 3,[m
[31m-            "face_visibility_history_frames": 10,[m
[31m-            "face_present_min_samples": 5,[m
[31m-            "partial_face_threshold": 0.4,[m
[31m-            # severity[m
[31m-            "long_duration_high_sec": 3.0,[m
[31m-        }[m
[31m-[m
[31m-        cfg = load_yaml_section(path, "detectors.distraction")[m
[31m-        thresholds = cfg.get("thresholds", {}) if isinstance(cfg.get("thresholds", {}), dict) else {}[m
[31m-        timing = cfg.get("timing", {}) if isinstance(cfg.get("timing", {}), dict) else {}[m
[31m-        smoothing = cfg.get("smoothing", {}) if isinstance(cfg.get("smoothing", {}), dict) else {}[m
[31m-        severity = cfg.get("severity", {}) if isinstance(cfg.get("severity", {}), dict) else {}[m
[31m-[m
[31m-        return {[m
[31m-            "yaw_threshold": float(thresholds.get("yaw_deg", defaults["yaw_deg"])),[m
[31m-            "pitch_down_threshold": float(thresholds.get("pitch_down_deg", defaults["pitch_down_deg"])),[m
[31m-            "pitch_up_threshold": float(thresholds.get("pitch_up_deg", defaults["pitch_up_deg"])),[m
[31m-            "time_hands_visible": float(timing.get("hands_visible_sec", defaults["hands_visible_sec"])),[m
[31m-            "time_gaze": float(timing.get("gaze_sec", defaults["gaze_sec"])),[m
[31m-            "history_frames": int(smoothing.get("history_frames", defaults["history_frames"])),[m
[31m-            "required_frames": int(smoothing.get("required_frames", defaults["required_frames"])),[m
[31m-            "face_visibility_history_frames": int([m
[31m-                smoothing.get("face_visibility_history_frames", defaults["face_visibility_history_frames"])[m
[31m-            ),[m
[31m-            "face_present_min_samples": int(smoothing.get("face_present_min_samples", defaults["face_present_min_samples"])),[m
[31m-            "partial_face_threshold": float(smoothing.get("partial_face_threshold", defaults["partial_face_threshold"])),[m
[31m-            "long_duration_high_sec": float(severity.get("long_duration_high_sec", defaults["long_duration_high_sec"])),[m
[31m-        }[m
[31m-[m
[31m-    def set_face_visibility(self, face_detection_confidence):[m
[31m-        """[m
[31m-        Call this each frame with face detection confidence (0.0-1.0)[m
[31m-        Helps distinguish between "face turned away" vs "no face detected"[m
[31m-        """[m
[31m-        self.face_visibility_history.append(face_detection_confidence if face_detection_confidence else 0.0)[m
[31m-[m
[31m-    def _is_face_present(self):[m
[31m-        """Check if face is at least partially visible"""[m
[31m-        if len(self.face_visibility_history) < self.face_present_min_samples:[m
[31m-            return True  # Benefit of doubt during startup[m
[31m-[m
[31m-        recent_vis = list(self.face_visibility_history)[-self.face_present_min_samples :][m
[31m-        avg_vis = sum(recent_vis) / len(recent_vis)[m
[31m-        return avg_vis >= self.partial_face_threshold[m
[31m-[m
[31m-    def analyze(self, pitch, yaw, roll, hands=None, face=None, is_drowsy=False, is_fainting=False):[m
[31m-        """[m
[31m-        Simple logic for face+shoulders camera view with priority handling.[m
[31m-[m
[31m-        Returns: (is_distracted, is_new_event, distraction_info)[m
[31m-        """[m
[31m-        # If fainting detected, don't report distraction[m
[31m-        if is_fainting:[m
[31m-            self.start_time = None[m
[31m-            self.is_distracted = False[m
[31m-            return False, False, None[m
[31m-[m
[31m-        if not (abs(pitch) < 90 and abs(yaw) < 90):[m
[31m-            return False, False, None[m
[31m-[m
[31m-        hands_visible = bool(hands and len(hands) > 0)[m
[31m-        dp = pitch - self.cal["pitch"][m
[31m-        dy = abs(yaw - self.cal["yaw"])[m
[31m-[m
[31m-        # Separate gaze violations based on direction[m
[31m-        looking_aside = dy > self.cfg["yaw_threshold"][m
[31m-        looking_down = dp > self.cfg["pitch_down_threshold"][m
[31m-        looking_up = dp < -self.cfg["pitch_up_threshold"][m
[31m-[m
[31m-        # If drowsy and looking down, don't count as distraction[m
[31m-        if is_drowsy and looking_down:[m
[31m-            self.start_time = None[m
[31m-            self.is_distracted = False[m
[31m-            return False, False, None[m
[31m-[m
[31m-        violation_type = None[m
[31m-        time_threshold = None[m
[31m-        alert_detail = None[m
[31m-        base_severity = "Medium"[m
[31m-[m
[31m-        if hands_visible:[m
[31m-            num_hands = len(hands)[m
[31m-            if num_hands == 1:[m
[31m-                violation_type = "ONE HAND OFF WHEEL"[m
[31m-                alert_detail = "One Hand Off Wheel"[m
[31m-                base_severity = "Medium"[m
[31m-            else:[m
[31m-                violation_type = "BOTH HANDS OFF WHEEL"[m
[31m-                alert_detail = "Both Hands Off Wheel"[m
[31m-                base_severity = "High"[m
[31m-            time_threshold = self.cfg["time_hands_visible"][m
[31m-        elif looking_aside:[m
[31m-            violation_type = "LOOKING ASIDE"[m
[31m-            alert_detail = "Looking Away from Road"[m
[31m-            base_severity = "Medium"[m
[31m-            time_threshold = self.cfg["time_gaze"][m
[31m-        elif looking_up:[m
[31m-            violation_type = "LOOKING UP"[m
[31m-            alert_detail = "Looking Up Away from Road"[m
[31m-            base_severity = "Medium"[m
[31m-            time_threshold = self.cfg["time_gaze"][m
[31m-        elif looking_down and not is_drowsy:[m
[31m-            violation_type = "LOOKING DOWN"[m
[31m-            alert_detail = "Looking Down at Device"[m
[31m-            base_severity = "Medium"[m
[31m-            time_threshold = self.cfg["time_gaze"][m
[31m-[m
[31m-        # Track in history (from YAML)[m
[31m-        self.history.append(violation_type is not None)[m
[31m-[m
[31m-        # Require N out of history_frames frames to have violation (from YAML)[m
[31m-        history_sum = sum(self.history)[m
[31m-        if history_sum >= self.cfg["required_frames"] and violation_type:[m
[31m-            if self.start_time is None or self.distraction_type != violation_type:[m
[31m-                self.start_time = time.time()[m
[31m-                self.distraction_type = violation_type[m
[31m-[m
[31m-            elapsed = time.time() - self.start_time[m
[31m-[m
[31m-            if elapsed >= time_threshold:[m
[31m-                if not self.is_distracted:[m
[31m-                    # New distraction event[m
[31m-                    self.is_distracted = True[m
[31m-                    self.metrics["total_distractions"] += 1[m
[31m-[m
[31m-                    # Determine final severity based on type + duration (from YAML)[m
[31m-                    if "BOTH HANDS" in violation_type:[m
[31m-                        final_severity = "High"[m
[31m-                    elif elapsed >= self.cfg["long_duration_high_sec"]:[m
[31m-                        final_severity = "High"[m
[31m-                    else:[m
[31m-                        final_severity = base_severity[m
[31m-[m
[31m-                    distraction_info = {"alert_detail": alert_detail, "severity": final_severity, "duration": elapsed}[m
[31m-                    return True, True, distraction_info[m
[31m-                else:[m
[31m-                    return True, False, None[m
[31m-[m
[31m-            return False, False, None[m
[31m-[m
[31m-        # No stable violation - reset[m
[31m-        self.start_time = None[m
[31m-        self.is_distracted = False[m
[31m-        self.distraction_type = "NORMAL"[m
[31m-        return False, False, None[m
[31m-[m
[31m-    def get_status(self):[m
[31m-        return {"is_distracted": self.is_distracted, "type": self.distraction_type, "metrics": self.metrics}[m
\ No newline at end of file[m
[1mdiff --git a/src/detectors/drowsiness.py b/src/detectors/drowsiness.py[m
[1mdeleted file mode 100644[m
[1mindex 1fa7250..0000000[m
[1m--- a/src/detectors/drowsiness.py[m
[1m+++ /dev/null[m
[36m@@ -1,299 +0,0 @@[m
[31m-import time[m
[31m-import logging[m
[31m-import math[m
[31m-import numpy as np[m
[31m-from collections import deque[m
[31m-from src.services.system_logger import SystemLogger[m
[31m-from src.utils.load_detector_config import load_yaml_section[m
[31m-[m
[31m-class DrowsinessDetector:[m
[31m-    """[m
[31m-    Detects drowsiness (low EAR over time) and yawning (MAR/expr/hands).[m
[31m-    Fainting is not judged here; use FaintingDetector separately.[m
[31m-    """[m
[31m-[m
[31m-    def __init__(self, logger: SystemLogger, fps: float = 30.0, config_path: str = "config/detector_config.yaml"):[m
[31m-        self.logger = logger[m
[31m-        self.fps = fps[m
[31m-        self.config = self._load_config(config_path)[m
[31m-        self.user = None[m
[31m-[m
[31m-        # State Tracking[m
[31m-        self._last_frame_rgb = None[m
[31m-[m
[31m-        # Use YAML-driven history length (seconds -> frames)[m
[31m-        self.ear_history = deque(maxlen=int(self.config["ear_history_frames"]))[m
[31m-        self.ear_drop_detected = False[m
[31m-[m
[31m-        # Dynamic EAR thresholds (loaded from user profile or config)[m
[31m-        self.dynamic_ear_thresh = self.config["ear_low"][m
[31m-[m
[31m-        self.counters = {[m
[31m-            'DROWSINESS': 0, 'RECOVERY': 0, 'YAW': 0, 'YAW_COOL': 0,[m
[31m-            'BLINK': 0, 'EYES_CLOSED': 0, 'SMILE_SUP': 0, 'LAUGH_SUP': 0,[m
[31m-        }[m
[31m-[m
[31m-        self.states = {'IS_DROWSY': False, 'IS_YAWNING': False, 'EYES_CLOSED': False}[m
[31m-        self.episode = {'active': False, 'start_time': None, 'min_ear': 1.0, 'start_frame': None}[m
[31m-[m
[31m-        # Yawn frequency tracking[m
[31m-        self.yawn_timestamps = deque(maxlen=10)  # Track last 10 yawns[m
[31m-        self.yawn_count = 0[m
[31m-        [m
[31m-        logging.info("DrowsinessDetector initialized (Clean, no fainting)")[m
[31m-[m
[31m-    def _load_config(self, path_str: str):[m
[31m-        # Defaults (fallback only)[m
[31m-        defaults = {[m
[31m-            "episode": {[m
[31m-                "start_threshold_sec": 0.5,[m
[31m-                "end_grace_sec": 1.5,[m
[31m-                "min_episode_sec": 2.0,[m
[31m-            },[m
[31m-            "ear": {[m
[31m-                "low_threshold": 0.22,[m
[31m-                "high_threshold": 0.26,[m
[31m-                "drop_threshold": 0.10,[m
[31m-                "drop_window_frames": 15,[m
[31m-                "history_sec": 1.0,[m
[31m-            },[m
[31m-            "blink": {"min_closed_frames": 1, "max_closed_frames": 10},[m
[31m-            "yawn": {[m
[31m-                "threshold_sec": 0.27,[m
[31m-                "cooldown_sec": 2.0,[m
[31m-                "hand_cover_distance_norm": 0.15,[m
[31m-                "frequency_window_sec": 120.0,[m
[31m-                "high_frequency_count": 3,[m
[31m-                "timestamps_max": 10,[m
[31m-            },[m
[31m-            "expression_suppression": {"smile_suppress_sec": 0.5, "laugh_suppress_sec": 0.67},[m
[31m-            "severity": {"drowsiness": {"medium_sec": 2.0, "high_sec": 3.0, "critical_sec": 5.0}},[m
[31m-        }[m
[31m-[m
[31m-        root = load_yaml_section(path_str, "detectors.drowsiness")[m
[31m-[m
[31m-        episode = root.get("episode", {}) if isinstance(root.get("episode", {}), dict) else {}[m
[31m-        ear = root.get("ear", {}) if isinstance(root.get("ear", {}), dict) else {}[m
[31m-        blink = root.get("blink", {}) if isinstance(root.get("blink", {}), dict) else {}[m
[31m-        yawn = root.get("yawn", {}) if isinstance(root.get("yawn", {}), dict) else {}[m
[31m-        sup = root.get("expression_suppression", {}) if isinstance(root.get("expression_suppression", {}), dict) else {}[m
[31m-        sev_root = root.get("severity", {}) if isinstance(root.get("severity", {}), dict) else {}[m
[31m-        sev = sev_root.get("drowsiness", {}) if isinstance(sev_root.get("drowsiness", {}), dict) else {}[m
[31m-[m
[31m-        start_sec = float(episode.get("start_threshold_sec", defaults["episode"]["start_threshold_sec"]))[m
[31m-        end_sec = float(episode.get("end_grace_sec", defaults["episode"]["end_grace_sec"]))[m
[31m-        history_sec = float(ear.get("history_sec", defaults["ear"]["history_sec"]))[m
[31m-[m
[31m-        return {[m
[31m-            # episode[m
[31m-            "drowsy_start": int(start_sec * self.fps),[m
[31m-            "drowsy_end": int(end_sec * self.fps),[m
[31m-            "min_episode_sec": float(episode.get("min_episode_sec", defaults["episode"]["min_episode_sec"])),[m
[31m-[m
[31m-            # ear[m
[31m-            "ear_low": float(ear.get("low_threshold", defaults["ear"]["low_threshold"])),[m
[31m-            "ear_high": float(ear.get("high_threshold", defaults["ear"]["high_threshold"])),[m
[31m-            "ear_drop": float(ear.get("drop_threshold", defaults["ear"]["drop_threshold"])),[m
[31m-            "ear_drop_window_frames": int(ear.get("drop_window_frames", defaults["ear"]["drop_window_frames"])),[m
[31m-            "ear_history_frames": max(1, int(history_sec * self.fps)),[m
[31m-[m
[31m-            # blink[m
[31m-            "blink_min_closed_frames": int(blink.get("min_closed_frames", defaults["blink"]["min_closed_frames"])),[m
[31m-            "blink_max_closed_frames": int(blink.get("max_closed_frames", defaults["blink"]["max_closed_frames"])),[m
[31m-[m
[31m-            # yawn[m
[31m-            "yawn_thresh": int(float(yawn.get("threshold_sec", defaults["yawn"]["threshold_sec"])) * self.fps),[m
[31m-            "yawn_cool": int(float(yawn.get("cooldown_sec", defaults["yawn"]["cooldown_sec"])) * self.fps),[m
[31m-            "hand_cover_distance_norm": float([m
[31m-                yawn.get("hand_cover_distance_norm", defaults["yawn"]["hand_cover_distance_norm"])[m
[31m-            ),[m
[31m-            "yawn_frequency_window_sec": float([m
[31m-                yawn.get("frequency_window_sec", defaults["yawn"]["frequency_window_sec"])[m
[31m-            ),[m
[31m-            "yawn_high_frequency_count": int([m
[31m-                yawn.get("high_frequency_count", defaults["yawn"]["high_frequency_count"])[m
[31m-            ),[m
[31m-            "yawn_timestamps_max": int(yawn.get("timestamps_max", defaults["yawn"]["timestamps_max"])),[m
[31m-[m
[31m-            # expression suppression[m
[31m-            "smile_sup": int(float(sup.get("smile_suppress_sec", defaults["expression_suppression"]["smile_suppress_sec"])) * self.fps),[m
[31m-            "laugh_sup": int(float(sup.get("laugh_suppress_sec", defaults["expression_suppression"]["laugh_suppress_sec"])) * self.fps),[m
[31m-[m
[31m-            # severity[m
[31m-            "sev_medium_sec": float(sev.get("medium_sec", defaults["severity"]["drowsiness"]["medium_sec"])),[m
[31m-            "sev_high_sec": float(sev.get("high_sec", defaults["severity"]["drowsiness"]["high_sec"])),[m
[31m-            "sev_critical_sec": float(sev.get("critical_sec", defaults["severity"]["drowsiness"]["critical_sec"])),[m
[31m-        }[m
[31m-[m
[31m-    def set_last_frame(self, frame):[m
[31m-        self._last_frame_rgb = frame.copy() if frame is not None else None[m
[31m-[m
[31m-    def set_active_user(self, user_profile):[m
[31m-        self.user = user_profile[m
[31m-        base_ear = user_profile.ear_threshold if user_profile else self.config['ear_low'][m
[31m-        self.dynamic_ear_thresh = base_ear[m
[31m-        self.config['ear_low'] = base_ear[m
[31m-        self.config['ear_high'] = base_ear * 1.2[m
[31m-        self._reset_state()[m
[31m-[m
[31m-    def _reset_state(self):[m
[31m-        keys = [[m
[31m-            'DROWSINESS', 'RECOVERY', 'YAW', 'YAWN_COOL',[m
[31m-            'BLINK', 'EYES_CLOSED', 'SMILE_SUP', 'LAUGH_SUP'[m
[31m-        ][m
[31m-        self.counters = {k: 0 for k in keys}[m
[31m-        self.episode['active'] = False[m
[31m-        self.states = {k: False for k in self.states}[m
[31m-        self.ear_history.clear()[m
[31m-        [m
[31m-    def detect(self, ear, mar, expression, hands_data=None, face_center=None, pitch=None):[m
[31m-        self.ear_history.append(ear)[m
[31m-        self._detect_sudden_ear_drop()[m
[31m-        self.states['EYES_CLOSED'] = ear < self.config['ear_low'][m
[31m-[m
[31m-        # Update suppressions and events[m
[31m-        self._update_suppression(expression)[m
[31m-        self._update_blink(ear)[m
[31m-        self._update_drowsiness(ear)[m
[31m-        self._update_yawn(mar, expression, hands_data, face_center)[m
[31m-[m
[31m-        if self.states['IS_DROWSY']:[m
[31m-            return "DROWSY", (0, 0, 255)[m
[31m-        if self.states['IS_YAWNING']:[m
[31m-            return "YAWNING", (0, 255, 255)[m
[31m-        return "NORMAL", (0, 255, 0)[m
[31m-[m
[31m-    def _detect_sudden_ear_drop(self):[m
[31m-        if len(self.ear_history) < 15:[m
[31m-            return[m
[31m-        drop = self.ear_history[-15] - self.ear_history[-1][m
[31m-        self.ear_drop_detected = (drop > self.config['ear_drop'])[m
[31m-[m
[31m-    def _update_suppression(self, expr):[m
[31m-        if expr == "SMILE":[m
[31m-            self.counters['SMILE_SUP'] = self.config['smile_sup'][m
[31m-        elif expr == "LAUGH":[m
[31m-            self.counters['LAUGH_SUP'] = self.config['laugh_sup'][m
[31m-        else:[m
[31m-            if self.counters['SMILE_SUP'] > 0:[m
[31m-                self.counters['SMILE_SUP'] -= 1[m
[31m-            if self.counters['LAUGH_SUP'] > 0:[m
[31m-                self.counters['LAUGH_SUP'] -= 1[m
[31m-[m
[31m-    def _update_drowsiness(self, ear):[m
[31m-        is_suppressed = self.counters['SMILE_SUP'] > 0 or self.counters['LAUGH_SUP'] > 0[m
[31m-[m
[31m-        if self.episode['active']:[m
[31m-            self.episode['min_ear'] = min(self.episode['min_ear'], ear)[m
[31m-            if ear >= self.config['ear_high'] or is_suppressed:[m
[31m-                self.counters['RECOVERY'] += 1[m
[31m-                if self.counters['RECOVERY'] >= self.config['drowsy_end']:[m
[31m-                    dur = time.time() - self.episode['start_time'][m
[31m-                    if dur >= self.config['min_episode_sec']:[m
[31m-                        # Determine severity[m
[31m-                        if dur >= 5.0:[m
[31m-                            severity = "Critical"[m
[31m-                        elif dur >= 3.0:[m
[31m-                            severity = "High"[m
[31m-                        elif dur >= 2.0:[m
[31m-                            severity = "Medium"[m
[31m-                        else:[m
[31m-                            severity = "Low"[m
[31m-                        [m
[31m-                        # Updated call - removed technical fields[m
[31m-                        self.logger.log_event([m
[31m-                            getattr(self.user, 'user_id', 0),[m
[31m-                            "DROWSY",[m
[31m-                            dur,[m
[31m-                            self.episode['min_ear'],  # Store EAR in 'value' field[m
[31m-                            self.episode['start_frame'],[m
[31m-                            alert_category="Drowsiness",[m
[31m-                            alert_detail="Eyes Closed Too Long",[m
[31m-                            severity=severity[m
[31m-                        )[m
[31m-                    self.episode['active'] = False[m
[31m-                    self.counters['DROWSINESS'] = 0[m
[31m-            else:[m
[31m-                self.counters['RECOVERY'] = 0[m
[31m-        elif ear < self.config['ear_low'] and not is_suppressed:[m
[31m-            self.counters['DROWSINESS'] += 1[m
[31m-            if self.counters['DROWSINESS'] >= self.config['drowsy_start']:[m
[31m-                self.episode.update({'active': True, 'start_time': time.time(), 'start_frame': self._last_frame_rgb, 'min_ear': 1.0})[m
[31m-                self.counters['RECOVERY'] = 0[m
[31m-        else:[m
[31m-            self.counters['DROWSINESS'] = 0[m
[31m-[m
[31m-        self.states['IS_DROWSY'] = self.episode['active'][m
[31m-[m
[31m-    def _update_blink(self, ear):[m
[31m-        """Track blinks for statistics."""[m
[31m-        if ear < self.dynamic_ear_thresh:[m
[31m-            self.counters['EYES_CLOSED'] += 1[m
[31m-        else:[m
[31m-            # Valid blink: eyes closed for 1-10 frames[m
[31m-            if 0 < self.counters['EYES_CLOSED'] < 10:[m
[31m-                self.counters['BLINK'] += 1[m
[31m-            self.counters['EYES_CLOSED'] = 0[m
[31m-[m
[31m-    def _update_yawn(self, mar, expr, hands, face):[m
[31m-        if self.counters['YAWN_COOL'] > 0:[m
[31m-            self.counters['YAWN_COOL'] -= 1[m
[31m-            self.states['IS_YAWNING'] = False[m
[31m-            return[m
[31m-[m
[31m-        covered = False[m
[31m-        if hands and face:[m
[31m-            for h in hands:[m
[31m-                if math.sqrt((h[12][0]-face[0])**2 + (h[12][1]-face[1])**2) < 0.15:[m
[31m-                    covered = True[m
[31m-                    break[m
[31m-[m
[31m-        if (expr == "YAWN") or (covered and expr not in ["SMILE", "LAUGH"]):[m
[31m-            self.counters['YAWN'] += 1[m
[31m-        else:[m
[31m-            self.counters['YAWN'] = 0[m
[31m-[m
[31m-        if self.counters['YAWN'] >= self.config['yawn_thresh']:[m
[31m-            if not self.states['IS_YAWNING']:[m
[31m-                now = time.time()[m
[31m-                self.yawn_timestamps.append(now)[m
[31m-                self.yawn_count += 1[m
[31m-                [m
[31m-                # Determine severity based on yawn frequency[m
[31m-                # High: 3+ yawns in last 2 minutes[m
[31m-                recent_yawns = sum(1 for t in self.yawn_timestamps if now - t < 120)[m
[31m-                [m
[31m-                if recent_yawns >= 3:[m
[31m-                    severity = "High"[m
[31m-                    alert_detail = f"Frequent Yawning ({recent_yawns} in 2 min)"[m
[31m-                    if covered:[m
[31m-                        alert_detail += " with Hand Near Face"[m
[31m-                elif covered:[m
[31m-                    severity = "Medium"[m
[31m-                    alert_detail = "Yawning with Hand Near Face"[m
[31m-                else:[m
[31m-                    severity = "Low"[m
[31m-                    alert_detail = "Yawning"[m
[31m-                [m
[31m-                # Updated call with dynamic severity[m
[31m-                self.logger.log_event([m
[31m-                    getattr(self.user, 'user_id', 0),[m
[31m-                    "YAWN",[m
[31m-                    0.0,[m
[31m-                    mar,  # Store MAR in 'value' field[m
[31m-                    self._last_frame_rgb,[m
[31m-                    alert_category="Drowsiness",[m
[31m-                    alert_detail=alert_detail,[m
[31m-                    severity=severity[m
[31m-                )[m
[31m-                self.counters['YAWN_COOL'] = self.config['yawn_cool'][m
[31m-                self.states['IS_YAWNING'] = True[m
[31m-[m
[31m-    def get_detailed_state(self):[m
[31m-        return {[m
[31m-            'is_drowsy': self.states['IS_DROWSY'],[m
[31m-            'is_yawning': self.states['IS_YAWNING'],[m
[31m-            'eyes_closed': self.states['EYES_CLOSED'],[m
[31m-            'blink_count': self.counters['BLINK'],[m
[31m-            'ear_trend': "STABLE"[m
[31m-        }[m
\ No newline at end of file[m
[1mdiff --git a/src/detectors/__init__.py b/src/status/__init__.py[m
[1msimilarity index 100%[m
[1mrename from src/detectors/__init__.py[m
[1mrename to src/status/__init__.py[m
[1mdiff --git a/src/status/distraction/__init__.py b/src/status/distraction/__init__.py[m
[1mnew file mode 100644[m
[1mindex 0000000..e69de29[m
[1mdiff --git a/src/status/distraction/config.py b/src/status/distraction/config.py[m
[1mnew file mode 100644[m
[1mindex 0000000..6b4c552[m
[1m--- /dev/null[m
[1m+++ b/src/status/distraction/config.py[m
[36m@@ -0,0 +1,37 @@[m
[32m+[m[32mfrom __future__ import annotations[m
[32m+[m
[32m+[m[32mfrom typing import Any, Dict[m
[32m+[m
[32m+[m[32mfrom src.utils.load_detector_config import load_yaml_section[m
[32m+[m[32mfrom src.utils.config_utils import as_float, as_int, get_section[m
[32m+[m
[32m+[m
[32m+[m[32mdef load_distraction_config(path: str) -> Dict[str, Any]:[m
[32m+[m[32m    root = load_yaml_section(path, "detectors.distraction")[m
[32m+[m
[32m+[m[32m    thresholds = get_section(root, "thresholds")[m
[32m+[m[32m    timing = get_section(root, "timing")[m
[32m+[m[32m    smoothing = get_section(root, "smoothing")[m
[32m+[m[32m    severity = get_section(root, "severity")[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        "thresholds": {[m
[32m+[m[32m            "yaw_deg": as_float(thresholds.get("yaw_deg"), 45.0),[m
[32m+[m[32m            "pitch_down_deg": as_float(thresholds.get("pitch_down_deg"), 20.0),[m
[32m+[m[32m            "pitch_up_deg": as_float(thresholds.get("pitch_up_deg"), 20.0),[m
[32m+[m[32m        },[m
[32m+[m[32m        "timing": {[m
[32m+[m[32m            "hands_visible_sec": as_float(timing.get("hands_visible_sec"), 1.5),[m
[32m+[m[32m            "gaze_sec": as_float(timing.get("gaze_sec"), 1.2),[m
[32m+[m[32m        },[m
[32m+[m[32m        "smoothing": {[m
[32m+[m[32m            "history_frames": as_int(smoothing.get("history_frames"), 5),[m
[32m+[m[32m            "required_frames": as_int(smoothing.get("required_frames"), 3),[m
[32m+[m[32m            "face_visibility_history_frames": as_int(smoothing.get("face_visibility_history_frames"), 10),[m
[32m+[m[32m            "face_present_min_samples": as_int(smoothing.get("face_present_min_samples"), 5),[m
[32m+[m[32m            "partial_face_threshold": as_float(smoothing.get("partial_face_threshold"), 0.4),[m
[32m+[m[32m        },[m
[32m+[m[32m        "severity": {[m
[32m+[m[32m            "long_duration_high_sec": as_float(severity.get("long_duration_high_sec"), 3.0),[m
[32m+[m[32m        },[m
[32m+[m[32m    }[m
\ No newline at end of file[m
[1mdiff --git a/src/status/distraction/detector.py b/src/status/distraction/detector.py[m
[1mnew file mode 100644[m
[1mindex 0000000..9a1775e[m
[1m--- /dev/null[m
[1m+++ b/src/status/distraction/detector.py[m
[36m@@ -0,0 +1,97 @@[m
[32m+[m[32mimport time[m
[32m+[m[32mimport logging[m
[32m+[m[32mfrom collections import deque[m
[32m+[m
[32m+[m[32mfrom src.status.distraction.config import load_distraction_config[m
[32m+[m[32mfrom src.status.distraction.rules import determine_violation, final_severity[m
[32m+[m
[32m+[m[32mlog = logging.getLogger(__name__)[m
[32m+[m
[32m+[m
[32m+[m[32mclass DistractionDetector:[m
[32m+[m[32m    def __init__(self, fps=30.0, camera_pitch=0.0, camera_yaw=0.0, config_path="config/detector_config.yaml"):[m
[32m+[m[32m        self.fps = fps[m
[32m+[m[32m        self.cfg = load_distraction_config(config_path)[m
[32m+[m
[32m+[m[32m        self.is_distracted = False[m
[32m+[m[32m        self.distraction_type = "NORMAL"[m
[32m+[m[32m        self.start_time = None[m
[32m+[m
[32m+[m[32m        self.cal = {"pitch": camera_pitch, "yaw": camera_yaw}[m
[32m+[m
[32m+[m[32m        self.history = deque(maxlen=int(self.cfg["smoothing"]["history_frames"]))[m
[32m+[m[32m        self.metrics = {"total_distractions": 0}[m
[32m+[m
[32m+[m[32m        self.face_visibility_history = deque(maxlen=int(self.cfg["smoothing"]["face_visibility_history_frames"]))[m
[32m+[m[32m        self.partial_face_threshold = float(self.cfg["smoothing"]["partial_face_threshold"])[m
[32m+[m[32m        self.face_present_min_samples = int(self.cfg["smoothing"]["face_present_min_samples"])[m
[32m+[m
[32m+[m[32m        log.info("DistractionDetector initialized")[m
[32m+[m
[32m+[m[32m    def set_face_visibility(self, face_detection_confidence):[m
[32m+[m[32m        self.face_visibility_history.append(face_detection_confidence if face_detection_confidence else 0.0)[m
[32m+[m
[32m+[m[32m    def _is_face_present(self):[m
[32m+[m[32m        if len(self.face_visibility_history) < self.face_present_min_samples:[m
[32m+[m[32m            return True[m
[32m+[m[32m        recent_vis = list(self.face_visibility_history)[-self.face_present_min_samples :][m
[32m+[m[32m        return (sum(recent_vis) / len(recent_vis)) >= self.partial_face_threshold[m
[32m+[m
[32m+[m[32m    def analyze(self, pitch, yaw, roll, hands=None, face=None, is_drowsy=False, is_fainting=False):[m
[32m+[m[32m        if is_fainting:[m
[32m+[m[32m            self.start_time = None[m
[32m+[m[32m            self.is_distracted = False[m
[32m+[m[32m            self.distraction_type = "NORMAL"[m
[32m+[m[32m            return False, False, None[m
[32m+[m
[32m+[m[32m        if not (abs(pitch) < 90 and abs(yaw) < 90):[m
[32m+[m[32m            return False, False, None[m
[32m+[m
[32m+[m[32m        hands_count = len(hands) if hands else 0[m
[32m+[m
[32m+[m[32m        violation_type, time_threshold, alert_detail, base_sev = determine_violation([m
[32m+[m[32m            pitch=float(pitch),[m
[32m+[m[32m            yaw=float(yaw),[m
[32m+[m[32m            cal_pitch=float(self.cal["pitch"]),[m
[32m+[m[32m            cal_yaw=float(self.cal["yaw"]),[m
[32m+[m[32m            yaw_thr=float(self.cfg["thresholds"]["yaw_deg"]),[m
[32m+[m[32m            pitch_down_thr=float(self.cfg["thresholds"]["pitch_down_deg"]),[m
[32m+[m[32m            pitch_up_thr=float(self.cfg["thresholds"]["pitch_up_deg"]),[m
[32m+[m[32m            hands_count=int(hands_count),[m
[32m+[m[32m            is_drowsy=bool(is_drowsy),[m
[32m+[m[32m            time_hands_visible=float(self.cfg["timing"]["hands_visible_sec"]),[m
[32m+[m[32m            time_gaze=float(self.cfg["timing"]["gaze_sec"]),[m
[32m+[m[32m        )[m
[32m+[m
[32m+[m[32m        self.history.append(violation_type is not None)[m
[32m+[m
[32m+[m[32m        if sum(self.history) >= int(self.cfg["smoothing"]["required_frames"]) and violation_type:[m
[32m+[m[32m            if self.start_time is None or self.distraction_type != violation_type:[m
[32m+[m[32m                self.start_time = time.time()[m
[32m+[m[32m                self.distraction_type = violation_type[m
[32m+[m
[32m+[m[32m            elapsed = time.time() - self.start_time[m
[32m+[m[32m            if elapsed >= float(time_threshold):[m
[32m+[m[32m                if not self.is_distracted:[m
[32m+[m[32m                    self.is_distracted = True[m
[32m+[m[32m                    self.metrics["total_distractions"] += 1[m
[32m+[m
[32m+[m[32m                    sev = final_severity([m
[32m+[m[32m                        violation_type,[m
[32m+[m[32m                        float(elapsed),[m
[32m+[m[32m                        float(self.cfg["severity"]["long_duration_high_sec"]),[m
[32m+[m[32m                        base_sev,[m
[32m+[m[32m                    )[m
[32m+[m[32m                    return True, True, {"alert_detail": alert_detail, "severity": sev, "duration": elapsed}[m
[32m+[m
[32m+[m[32m                return True, False, None[m
[32m+[m
[32m+[m[32m            return False, False, None[m
[32m+[m
[32m+[m[32m        self.start_time = None[m
[32m+[m[32m        self.is_distracted = False[m
[32m+[m[32m        self.distraction_type = "NORMAL"[m
[32m+[m[32m        return False, False, None[m
[32m+[m
[32m+[m[32m    def get_status(self):[m
[32m+[m[32m        return {"is_distracted": self.is_distracted, "type": self.distraction_type, "metrics": self.metrics}[m
\ No newline at end of file[m
[1mdiff --git a/src/status/distraction/rules.py b/src/status/distraction/rules.py[m
[1mnew file mode 100644[m
[1mindex 0000000..65b5d05[m
[1m--- /dev/null[m
[1m+++ b/src/status/distraction/rules.py[m
[36m@@ -0,0 +1,55 @@[m
[32m+[m[32mfrom __future__ import annotations[m
[32m+[m
[32m+[m[32mfrom typing import Optional, Tuple[m
[32m+[m
[32m+[m
[32m+[m[32mdef determine_violation([m
[32m+[m[32m    *,[m
[32m+[m[32m    pitch: float,[m
[32m+[m[32m    yaw: float,[m
[32m+[m[32m    cal_pitch: float,[m
[32m+[m[32m    cal_yaw: float,[m
[32m+[m[32m    yaw_thr: float,[m
[32m+[m[32m    pitch_down_thr: float,[m
[32m+[m[32m    pitch_up_thr: float,[m
[32m+[m[32m    hands_count: int,[m
[32m+[m[32m    is_drowsy: bool,[m
[32m+[m[32m    time_hands_visible: float,[m
[32m+[m[32m    time_gaze: float,[m
[32m+[m[32m) -> Tuple[Optional[str], Optional[float], Optional[str], str]:[m
[32m+[m[32m    """[m
[32m+[m[32m    Returns: (violation_type, time_threshold_sec, alert_detail, base_severity)[m
[32m+[m[32m    """[m
[32m+[m[32m    hands_visible = hands_count > 0[m
[32m+[m
[32m+[m[32m    dp = pitch - cal_pitch[m
[32m+[m[32m    dy = abs(yaw - cal_yaw)[m
[32m+[m
[32m+[m[32m    looking_aside = dy > yaw_thr[m
[32m+[m[32m    looking_down = dp > pitch_down_thr[m
[32m+[m[32m    looking_up = dp < -pitch_up_thr[m
[32m+[m
[32m+[m[32m    if is_drowsy and looking_down:[m
[32m+[m[32m        return None, None, None, "Medium"[m
[32m+[m
[32m+[m[32m    if hands_visible:[m
[32m+[m[32m        if hands_count == 1:[m
[32m+[m[32m            return "ONE HAND OFF WHEEL", time_hands_visible, "One Hand Off Wheel", "Medium"[m
[32m+[m[32m        return "BOTH HANDS OFF WHEEL", time_hands_visible, "Both Hands Off Wheel", "High"[m
[32m+[m
[32m+[m[32m    if looking_aside:[m
[32m+[m[32m        return "LOOKING ASIDE", time_gaze, "Looking Away from Road", "Medium"[m
[32m+[m[32m    if looking_up:[m
[32m+[m[32m        return "LOOKING UP", time_gaze, "Looking Up Away from Road", "Medium"[m
[32m+[m[32m    if looking_down and not is_drowsy:[m
[32m+[m[32m        return "LOOKING DOWN", time_gaze, "Looking Down at Device", "Medium"[m
[32m+[m
[32m+[m[32m    return None, None, None, "Medium"[m
[32m+[m
[32m+[m
[32m+[m[32mdef final_severity(violation_type: str, elapsed_sec: float, long_duration_high_sec: float, base_severity: str) -> str:[m
[32m+[m[32m    if "BOTH HANDS" in violation_type:[m
[32m+[m[32m        return "High"[m
[32m+[m[32m    if elapsed_sec >= long_duration_high_sec:[m
[32m+[m[32m        return "High"[m
[32m+[m[32m    return base_severity[m
\ No newline at end of file[m
[1mdiff --git a/src/status/drowsiness/__init__.py b/src/status/drowsiness/__init__.py[m
[1mnew file mode 100644[m
[1mindex 0000000..e69de29[m
[1mdiff --git a/src/status/drowsiness/config.py b/src/status/drowsiness/config.py[m
[1mnew file mode 100644[m
[1mindex 0000000..2ecb33b[m
[1m--- /dev/null[m
[1m+++ b/src/status/drowsiness/config.py[m
[36m@@ -0,0 +1,61 @@[m
[32m+[m[32mfrom __future__ import annotations[m
[32m+[m
[32m+[m[32mfrom typing import Any, Dict[m
[32m+[m
[32m+[m[32mfrom src.utils.load_detector_config import load_yaml_section[m
[32m+[m[32mfrom src.utils.config_utils import as_float, as_int, get_section, sec_to_frames[m
[32m+[m
[32m+[m
[32m+[m[32mdef load_drowsiness_config(path: str, fps: float) -> Dict[str, Any]:[m
[32m+[m[32m    root = load_yaml_section(path, "detectors.drowsiness")[m
[32m+[m
[32m+[m[32m    episode = get_section(root, "episode")[m
[32m+[m[32m    ear = get_section(root, "ear")[m
[32m+[m[32m    blink = get_section(root, "blink")[m
[32m+[m[32m    yawn = get_section(root, "yawn")[m
[32m+[m[32m    sup = get_section(root, "expression_suppression")[m
[32m+[m[32m    sev_root = get_section(root, "severity")[m
[32m+[m[32m    sev = get_section(sev_root, "drowsiness")[m
[32m+[m
[32m+[m[32m    ear_low = as_float(ear.get("low_threshold"), 0.22)[m
[32m+[m[32m    ear_high = as_float(ear.get("high_threshold"), 0.26)[m
[32m+[m[32m    ear_high_ratio = (ear_high / ear_low) if ear_low > 0 else 1.2[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        "episode": {[m
[32m+[m[32m            "start_frames": sec_to_frames(episode.get("start_threshold_sec"), fps, 0.5),[m
[32m+[m[32m            "end_frames": sec_to_frames(episode.get("end_grace_sec"), fps, 1.5),[m
[32m+[m[32m            "min_episode_sec": as_float(episode.get("min_episode_sec"), 2.0),[m
[32m+[m[32m        },[m
[32m+[m[32m        "ear": {[m
[32m+[m[32m            "low": ear_low,[m
[32m+[m[32m            "high": ear_high,[m
[32m+[m[32m            "high_ratio": float(ear_high_ratio),[m
[32m+[m[32m            "drop": as_float(ear.get("drop_threshold"), 0.10),[m
[32m+[m[32m            "drop_window_frames": as_int(ear.get("drop_window_frames"), 15),[m
[32m+[m[32m            "history_frames": sec_to_frames(ear.get("history_sec"), fps, 1.0),[m
[32m+[m[32m        },[m
[32m+[m[32m        "blink": {[m
[32m+[m[32m            "min_closed_frames": as_int(blink.get("min_closed_frames"), 1),[m
[32m+[m[32m            "max_closed_frames": as_int(blink.get("max_closed_frames"), 10),[m
[32m+[m[32m        },[m
[32m+[m[32m        "yawn": {[m
[32m+[m[32m            "thresh_frames": sec_to_frames(yawn.get("threshold_sec"), fps, 0.27),[m
[32m+[m[32m            "cooldown_frames": sec_to_frames(yawn.get("cooldown_sec"), fps, 2.0),[m
[32m+[m[32m            "hand_cover_distance_norm": as_float(yawn.get("hand_cover_distance_norm"), 0.15),[m
[32m+[m[32m            "frequency_window_sec": as_float(yawn.get("frequency_window_sec"), 120.0),[m
[32m+[m[32m            "high_frequency_count": as_int(yawn.get("high_frequency_count"), 3),[m
[32m+[m[32m            "timestamps_max": as_int(yawn.get("timestamps_max"), 10),[m
[32m+[m[32m        },[m
[32m+[m[32m        "expression_suppression": {[m
[32m+[m[32m            "smile_frames": sec_to_frames(sup.get("smile_suppress_sec"), fps, 0.5),[m
[32m+[m[32m            "laugh_frames": sec_to_frames(sup.get("laugh_suppress_sec"), fps, 0.67),[m
[32m+[m[32m        },[m
[32m+[m[32m        "severity": {[m
[32m+[m[32m            "drowsiness": {[m
[32m+[m[32m                "medium_sec": as_float(sev.get("medium_sec"), 2.0),[m
[32m+[m[32m                "high_sec": as_float(sev.get("high_sec"), 3.0),[m
[32m+[m[32m                "critical_sec": as_float(sev.get("critical_sec"), 5.0),[m
[32m+[m[32m            }[m
[32m+[m[32m        },[m
[32m+[m[32m    }[m
\ No newline at end of file[m
[1mdiff --git a/src/status/drowsiness/detector.py b/src/status/drowsiness/detector.py[m
[1mnew file mode 100644[m
[1mindex 0000000..612fe4c[m
[1m--- /dev/null[m
[1m+++ b/src/status/drowsiness/detector.py[m
[36m@@ -0,0 +1,232 @@[m
[32m+[m[32mimport time[m
[32m+[m[32mfrom collections import deque[m
[32m+[m
[32m+[m[32mfrom src.services.system_logger import SystemLogger[m
[32m+[m[32mfrom src.status.drowsiness.config import load_drowsiness_config[m
[32m+[m[32mfrom src.status.drowsiness.events import log_drowsy_episode, log_yawn[m
[32m+[m
[32m+[m
[32m+[m[32mclass DrowsinessDetector:[m
[32m+[m[32m    """[m
[32m+[m[32m    Detects drowsiness (low EAR over time) and yawning (MAR/expr/hands).[m
[32m+[m[32m    """[m
[32m+[m
[32m+[m[32m    def __init__(self, logger: SystemLogger, fps: float = 30.0, config_path: str = "config/detector_config.yaml"):[m
[32m+[m[32m        self.logger = logger[m
[32m+[m[32m        self.fps = fps[m
[32m+[m[32m        self.cfg = load_drowsiness_config(config_path, fps)[m
[32m+[m[32m        self.user = None[m
[32m+[m
[32m+[m[32m        self._last_frame_rgb = None[m
[32m+[m
[32m+[m[32m        self.ear_history = deque(maxlen=int(self.cfg["ear"]["history_frames"]))[m
[32m+[m[32m        self.ear_drop_detected = False[m
[32m+[m
[32m+[m[32m        self.dynamic_ear_thresh = float(self.cfg["ear"]["low"])[m
[32m+[m
[32m+[m[32m        self.counters = {[m
[32m+[m[32m            "DROWSINESS": 0,[m
[32m+[m[32m            "RECOVERY": 0,[m
[32m+[m[32m            "BLINK": 0,[m
[32m+[m[32m            "EYES_CLOSED": 0,[m
[32m+[m[32m            "SMILE_SUP": 0,[m
[32m+[m[32m            "LAUGH_SUP": 0,[m
[32m+[m[32m            "YAWN": 0,[m
[32m+[m[32m            "YAWN_COOL": 0,[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        self.states = {"IS_DROWSY": False, "IS_YAWNING": False, "EYES_CLOSED": False}[m
[32m+[m[32m        self.episode = {"active": False, "start_time": None, "min_ear": 1.0, "start_frame": None}[m
[32m+[m
[32m+[m[32m        self.yawn_timestamps = deque(maxlen=int(self.cfg["yawn"]["timestamps_max"]))[m
[32m+[m[32m        self.yawn_count = 0[m
[32m+[m
[32m+[m[32m    def set_last_frame(self, frame):[m
[32m+[m[32m        self._last_frame_rgb = frame.copy() if frame is not None else None[m
[32m+[m
[32m+[m[32m    def set_active_user(self, user_profile):[m
[32m+[m[32m        self.user = user_profile[m
[32m+[m[32m        base_ear = float(user_profile.ear_threshold) if user_profile else float(self.cfg["ear"]["low"])[m
[32m+[m
[32m+[m[32m        self.dynamic_ear_thresh = base_ear[m
[32m+[m[32m        self.cfg["ear"]["low"] = base_ear[m
[32m+[m
[32m+[m[32m        ratio = float(self.cfg["ear"].get("high_ratio", 1.2))[m
[32m+[m[32m        self.cfg["ear"]["high"] = base_ear * ratio[m
[32m+[m
[32m+[m[32m        self._reset_state()[m
[32m+[m
[32m+[m[32m    def _reset_state(self):[m
[32m+[m[32m        for k in self.counters.keys():[m
[32m+[m[32m            self.counters[k] = 0[m
[32m+[m[32m        self.episode.update({"active": False, "start_time": None, "min_ear": 1.0, "start_frame": None})[m
[32m+[m[32m        for k in self.states.keys():[m
[32m+[m[32m            self.states[k] = False[m
[32m+[m[32m        self.ear_history.clear()[m
[32m+[m[32m        self.yawn_timestamps.clear()[m
[32m+[m
[32m+[m[32m    def detect(self, ear, mar, expression, hands_data=None, face_center=None, pitch=None):[m
[32m+[m[32m        ear = float(ear)[m
[32m+[m[32m        mar = float(mar)[m
[32m+[m
[32m+[m[32m        self.ear_history.append(ear)[m
[32m+[m[32m        self._detect_sudden_ear_drop()[m
[32m+[m
[32m+[m[32m        self.states["EYES_CLOSED"] = ear < float(self.cfg["ear"]["low"])[m
[32m+[m
[32m+[m[32m        self._update_suppression(expression)[m
[32m+[m[32m        self._update_blink(ear)[m
[32m+[m[32m        self._update_drowsiness(ear)[m
[32m+[m[32m        self._update_yawn(mar, expression, hands_data, face_center)[m
[32m+[m
[32m+[m[32m        if self.states["IS_DROWSY"]:[m
[32m+[m[32m            return "DROWSY", (0, 0, 255)[m
[32m+[m[32m        if self.states["IS_YAWNING"]:[m
[32m+[m[32m            return "YAWNING", (0, 255, 255)[m
[32m+[m[32m        return "NORMAL", (0, 255, 0)[m
[32m+[m
[32m+[m[32m    def _detect_sudden_ear_drop(self):[m
[32m+[m[32m        n = int(self.cfg["ear"]["drop_window_frames"])[m
[32m+[m[32m        if len(self.ear_history) < n:[m
[32m+[m[32m            return[m
[32m+[m[32m        drop = self.ear_history[-n] - self.ear_history[-1][m
[32m+[m[32m        self.ear_drop_detected = drop > float(self.cfg["ear"]["drop"])[m
[32m+[m
[32m+[m[32m    def _update_suppression(self, expr):[m
[32m+[m[32m        if expr == "SMILE":[m
[32m+[m[32m            self.counters["SMILE_SUP"] = int(self.cfg["expression_suppression"]["smile_frames"])[m
[32m+[m[32m        elif expr == "LAUGH":[m
[32m+[m[32m            self.counters["LAUGH_SUP"] = int(self.cfg["expression_suppression"]["laugh_frames"])[m
[32m+[m[32m        else:[m
[32m+[m[32m            if self.counters["SMILE_SUP"] > 0:[m
[32m+[m[32m                self.counters["SMILE_SUP"] -= 1[m
[32m+[m[32m            if self.counters["LAUGH_SUP"] > 0:[m
[32m+[m[32m                self.counters["LAUGH_SUP"] -= 1[m
[32m+[m
[32m+[m[32m    def _update_drowsiness(self, ear: float):[m
[32m+[m[32m        is_suppressed = self.counters["SMILE_SUP"] > 0 or self.counters["LAUGH_SUP"] > 0[m
[32m+[m
[32m+[m[32m        start_frames = int(self.cfg["episode"]["start_frames"])[m
[32m+[m[32m        end_frames = int(self.cfg["episode"]["end_frames"])[m
[32m+[m[32m        ear_low = float(self.cfg["ear"]["low"])[m
[32m+[m[32m        ear_high = float(self.cfg["ear"]["high"])[m
[32m+[m
[32m+[m[32m        if self.episode["active"]:[m
[32m+[m[32m            self.episode["min_ear"] = min(self.episode["min_ear"], ear)[m
[32m+[m
[32m+[m[32m            if ear >= ear_high or is_suppressed:[m
[32m+[m[32m                self.counters["RECOVERY"] += 1[m
[32m+[m[32m                if self.counters["RECOVERY"] >= end_frames:[m
[32m+[m[32m                    dur = time.time() - float(self.episode["start_time"] or time.time())[m
[32m+[m
[32m+[m[32m                    if dur >= float(self.cfg["episode"]["min_episode_sec"]):[m
[32m+[m[32m                        sev_cfg = self.cfg["severity"]["drowsiness"][m
[32m+[m[32m                        if dur >= float(sev_cfg["critical_sec"]):[m
[32m+[m[32m                            severity = "Critical"[m
[32m+[m[32m                        elif dur >= float(sev_cfg["high_sec"]):[m
[32m+[m[32m                            severity = "High"[m
[32m+[m[32m                        elif dur >= float(sev_cfg["medium_sec"]):[m
[32m+[m[32m                            severity = "Medium"[m
[32m+[m[32m                        else:[m
[32m+[m[32m                            severity = "Low"[m
[32m+[m
[32m+[m[32m                        log_drowsy_episode([m
[32m+[m[32m                            self.logger,[m
[32m+[m[32m                            self.user,[m
[32m+[m[32m                            dur,[m
[32m+[m[32m                            float(self.episode["min_ear"]),[m
[32m+[m[32m                            self.episode["start_frame"],[m
[32m+[m[32m                            severity,[m
[32m+[m[32m                        )[m
[32m+[m
[32m+[m[32m                    self.episode["active"] = False[m
[32m+[m[32m                    self.counters["DROWSINESS"] = 0[m
[32m+[m[32m            else:[m
[32m+[m[32m                self.counters["RECOVERY"] = 0[m
[32m+[m
[32m+[m[32m        elif ear < ear_low and not is_suppressed:[m
[32m+[m[32m            self.counters["DROWSINESS"] += 1[m
[32m+[m[32m            if self.counters["DROWSINESS"] >= start_frames:[m
[32m+[m[32m                self.episode.update([m
[32m+[m[32m                    {"active": True, "start_time": time.time(), "start_frame": self._last_frame_rgb, "min_ear": 1.0}[m
[32m+[m[32m                )[m
[32m+[m[32m                self.counters["RECOVERY"] = 0[m
[32m+[m[32m        else:[m
[32m+[m[32m            self.counters["DROWSINESS"] = 0[m
[32m+[m
[32m+[m[32m        self.states["IS_DROWSY"] = bool(self.episode["active"])[m
[32m+[m
[32m+[m[32m    def _update_blink(self, ear: float):[m
[32m+[m[32m        if ear < float(self.dynamic_ear_thresh):[m
[32m+[m[32m            self.counters["EYES_CLOSED"] += 1[m
[32m+[m[32m            return[m
[32m+[m
[32m+[m[32m        closed = int(self.counters["EYES_CLOSED"])[m
[32m+[m[32m        min_f = int(self.cfg["blink"]["min_closed_frames"])[m
[32m+[m[32m        max_f = int(self.cfg["blink"]["max_closed_frames"])[m
[32m+[m[32m        if min_f <= closed <= max_f:[m
[32m+[m[32m            self.counters["BLINK"] += 1[m
[32m+[m[32m        self.counters["EYES_CLOSED"] = 0[m
[32m+[m
[32m+[m[32m    def _update_yawn(self, mar: float, expr, hands, face):[m
[32m+[m[32m        if self.counters["YAWN_COOL"] > 0:[m
[32m+[m[32m            self.counters["YAWN_COOL"] -= 1[m
[32m+[m[32m            self.states["IS_YAWNING"] = False[m
[32m+[m[32m            return[m
[32m+[m
[32m+[m[32m        covered = False[m
[32m+[m[32m        if hands and face:[m
[32m+[m[32m            thr = float(self.cfg["yawn"]["hand_cover_distance_norm"])[m
[32m+[m[32m            thr2 = thr * thr[m
[32m+[m[32m            fx, fy = float(face[0]), float(face[1])[m
[32m+[m
[32m+[m[32m            for h in hands:[m
[32m+[m[32m                if not h or len(h) <= 12:[m
[32m+[m[32m                    continue[m
[32m+[m[32m                hx, hy = float(h[12][0]), float(h[12][1])[m
[32m+[m[32m                dx = hx - fx[m
[32m+[m[32m                dy = hy - fy[m
[32m+[m[32m                if (dx * dx + dy * dy) < thr2:[m
[32m+[m[32m                    covered = True[m
[32m+[m[32m                    break[m
[32m+[m
[32m+[m[32m        if (expr == "YAWN") or (covered and expr not in ["SMILE", "LAUGH"]):[m
[32m+[m[32m            self.counters["YAWN"] += 1[m
[32m+[m[32m        else:[m
[32m+[m[32m            self.counters["YAWN"] = 0[m
[32m+[m
[32m+[m[32m        if self.counters["YAWN"] >= int(self.cfg["yawn"]["thresh_frames"]):[m
[32m+[m[32m            if not self.states["IS_YAWNING"]:[m
[32m+[m[32m                now = time.time()[m
[32m+[m[32m                self.yawn_timestamps.append(now)[m
[32m+[m[32m                self.yawn_count += 1[m
[32m+[m
[32m+[m[32m                win = float(self.cfg["yawn"]["frequency_window_sec"])[m
[32m+[m[32m                hi_n = int(self.cfg["yawn"]["high_frequency_count"])[m
[32m+[m[32m                recent_yawns = sum(1 for t in self.yawn_timestamps if now - t < win)[m
[32m+[m
[32m+[m[32m                if recent_yawns >= hi_n:[m
[32m+[m[32m                    severity = "High"[m
[32m+[m[32m                    alert_detail = f"Frequent Yawning ({recent_yawns} in {int(win)} sec)"[m
[32m+[m[32m                    if covered:[m
[32m+[m[32m                        alert_detail += " with Hand Near Face"[m
[32m+[m[32m                elif covered:[m
[32m+[m[32m                    severity = "Medium"[m
[32m+[m[32m                    alert_detail = "Yawning with Hand Near Face"[m
[32m+[m[32m                else:[m
[32m+[m[32m                    severity = "Low"[m
[32m+[m[32m                    alert_detail = "Yawning"[m
[32m+[m
[32m+[m[32m                log_yawn(self.logger, self.user, mar, self._last_frame_rgb, alert_detail, severity)[m
[32m+[m
[32m+[m[32m                self.counters["YAWN_COOL"] = int(self.cfg["yawn"]["cooldown_frames"])[m
[32m+[m[32m                self.states["IS_YAWNING"] = True[m
[32m+[m
[32m+[m[32m    def get_detailed_state(self):[m
[32m+[m[32m        return {[m
[32m+[m[32m            "is_drowsy": self.states["IS_DROWSY"],[m
[32m+[m[32m            "is_yawning": self.states["IS_YAWNING"],[m
[32m+[m[32m            "eyes_closed": self.states["EYES_CLOSED"],[m
[32m+[m[32m            "blink_count": self.counters["BLINK"],[m
[32m+[m[32m            "ear_trend": "STABLE",[m
[32m+[m[32m        }[m
\ No newline at end of file[m
[1mdiff --git a/src/status/drowsiness/events.py b/src/status/drowsiness/events.py[m
[1mnew file mode 100644[m
[1mindex 0000000..bd76711[m
[1m--- /dev/null[m
[1m+++ b/src/status/drowsiness/events.py[m
[36m@@ -0,0 +1,29 @@[m
[32m+[m[32mfrom __future__ import annotations[m
[32m+[m
[32m+[m[32mfrom typing import Any, Optional[m
[32m+[m
[32m+[m
[32m+[m[32mdef log_drowsy_episode(logger, user: Optional[Any], duration_sec: float, min_ear: float, frame: Any, severity: str) -> None:[m
[32m+[m[32m    logger.log_event([m
[32m+[m[32m        getattr(user, "user_id", 0),[m
[32m+[m[32m        "DROWSY",[m
[32m+[m[32m        duration_sec,[m
[32m+[m[32m        min_ear,[m
[32m+[m[32m        frame,[m
[32m+[m[32m        alert_category="Drowsiness",[m
[32m+[m[32m        alert_detail="Eyes Closed Too Long",[m
[32m+[m[32m        severity=severity,[m
[32m+[m[32m    )[m
[32m+[m
[32m+[m
[32m+[m[32mdef log_yawn(logger, user: Optional[Any], mar: float, frame: Any, alert_detail: str, severity: str) -> None:[m
[32m+[m[32m    logger.log_event([m
[32m+[m[32m        getattr(user, "user_id", 0),[m
[32m+[m[32m        "YAWN",[m
[32m+[m[32m        0.0,[m
[32m+[m[32m        mar,[m
[32m+[m[32m        frame,[m
[32m+[m[32m        alert_category="Drowsiness",[m
[32m+[m[32m        alert_detail=alert_detail,[m
[32m+[m[32m        severity=severity,[m
[32m+[m[32m    )[m
\ No newline at end of file[m
[1mdiff --git a/src/detectors/expression.py b/src/status/expression.py[m
[1msimilarity index 100%[m
[1mrename from src/detectors/expression.py[m
[1mrename to src/status/expression.py[m
[1mdiff --git a/src/utils/config_utils.py b/src/utils/config_utils.py[m
[1mnew file mode 100644[m
[1mindex 0000000..ca50382[m
[1m--- /dev/null[m
[1m+++ b/src/utils/config_utils.py[m
[36m@@ -0,0 +1,26 @@[m
[32m+[m[32mfrom __future__ import annotations[m
[32m+[m
[32m+[m[32mfrom typing import Any, Dict[m
[32m+[m
[32m+[m
[32m+[m[32mdef as_float(x: Any, default: float) -> float:[m
[32m+[m[32m    try:[m
[32m+[m[32m        return float(x)[m
[32m+[m[32m    except Exception:[m
[32m+[m[32m        return float(default)[m
[32m+[m
[32m+[m
[32m+[m[32mdef as_int(x: Any, default: int) -> int:[m
[32m+[m[32m    try:[m
[32m+[m[32m        return int(x)[m
[32m+[m[32m    except Exception:[m
[32m+[m[32m        return int(default)[m
[32m+[m
[32m+[m
[32m+[m[32mdef sec_to_frames(sec: Any, fps: float, default_sec: float) -> int:[m
[32m+[m[32m    return max(1, int(as_float(sec, default_sec) * float(fps)))[m
[32m+[m
[32m+[m
[32m+[m[32mdef get_section(root: Dict[str, Any], key: str) -> Dict[str, Any]:[m
[32m+[m[32m    v = root.get(key, {})[m
[32m+[m[32m    return v if isinstance(v, dict) else {}[m
\ No newline at end of file[m
